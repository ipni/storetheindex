apiVersion: apps.foundationdb.org/v1beta2
kind: FoundationDBCluster
metadata:
  name: fdb-prod-cluster
spec:
  version: 7.1.33
  storageServersPerPod: 2
  automationOptions:
    replacements:
      enabled: true
  faultDomain:
    key: kubernetes.io/hostname
    valueFrom: spec.nodeName
  databaseConfiguration:
    storage_engine: ssd-rocksdb-v1
  processCounts:
    storage: 5
    log: 2
    coordinator: 3
    stateless: -1
  labels:
    matchLabels:
      foundationdb.org/fdb-cluster-name: fdb-prod-cluster
    processClassLabels:
      - foundationdb.org/fdb-process-class
    processGroupIDLabels:
      - foundationdb.org/fdb-process-group-id
  minimumUptimeSecondsForBounce: 60
  processes:
    general:
      volumeClaimTemplate:
        spec:
          storageClassName: gp3
    log:
      customParameters:
        - memory=50GiB
        - cache-memory=32GiB
        # Increase the default max outstanding IO operations (64), used in AIO with O_DIRECT interface.
        - knob_max_outstanding=256
      podTemplate:
        spec:
          topologySpreadConstraints:
            - maxSkew: 1
              topologyKey: topology.kubernetes.io/zone
              whenUnsatisfiable: ScheduleAnyway
          affinity:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                  - matchExpressions:
                      - key: node.kubernetes.io/instance-type
                        operator: In
                        values:
                          # 32 CPU, 64GiB memory
                          - c6a.8xlarge
          containers:
            - name: foundationdb
              resources:
                requests:
                  cpu: 30
                  memory: 57Gi
              securityContext:
                runAsUser: 0
      volumeClaimTemplate:
        spec:
          storageClassName: gp3-iops16k-t1000
          resources:
            requests:
              storage: 2Ti
    storage:
      customParameters:
        - memory=20GiB
        - cache-memory=12GiB
        # Increase the default max outstanding IO operations (64), used in AIO with O_DIRECT interface.
        - knob_max_outstanding=256
      podTemplate:
        spec:
          topologySpreadConstraints:
            - maxSkew: 1
              topologyKey: topology.kubernetes.io/zone
              whenUnsatisfiable: ScheduleAnyway
          affinity:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                  - matchExpressions:
                      - key: node.kubernetes.io/instance-type
                        operator: In
                        values:
                          # 32 CPU, 64GiB memory
                          - c6a.8xlarge
          containers:
            - name: foundationdb
              resources:
                requests:
                  cpu: 30
                  memory: 57Gi
              securityContext:
                runAsUser: 0
      volumeClaimTemplate:
        spec:
          storageClassName: gp3-iops16k-t1000
          resources:
            requests:
              storage: 16Ti
  sidecarContainer:
    enableReadinessProbe: false
    enableLivenessProbe: true
  routing:
    useDNSInClusterFile: true
  replaceInstancesWhenResourcesChange: true