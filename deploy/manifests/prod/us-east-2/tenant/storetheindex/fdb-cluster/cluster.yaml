apiVersion: apps.foundationdb.org/v1beta2
kind: FoundationDBCluster
metadata:
  name: fdb-prod-cluster
spec:
  version: 7.3.7
  storageServersPerPod: 1
  automationOptions:
    replacements:
      enabled: false
  faultDomain:
    key: kubernetes.io/hostname
    valueFrom: spec.nodeName
  databaseConfiguration:
    storage_engine: ssd-redwood-1-experimental
  processCounts:
    storage: 3
    log: 2
    coordinator: 3
    stateless: -1
    data_distributor: 2
    ratekeeper: 2
  labels:
    matchLabels:
      foundationdb.org/fdb-cluster-name: fdb-prod-cluster
    processClassLabels:
      - foundationdb.org/fdb-process-class
    processGroupIDLabels:
      - foundationdb.org/fdb-process-group-id
  minimumUptimeSecondsForBounce: 60
  processes:
    general:
      customParameters:
      - knob-max-generations-override=200
      volumeClaimTemplate:
        spec:
          storageClassName: gp3
    log:
      customParameters:
        - memory=50GiB
        - cache-memory=12GiB
        # Increase the default max outstanding IO operations (64), used in AIO with O_DIRECT interface.
        - knob_max_outstanding=256
        # Increase relocation and fetch keys parallelism to speed up data distribution across the cluster.
        - knob_relocation_parallelism_per_source_server=8
        - knob_fetch_keys_parallelism_bytes=5000000
        - knob_max_queue_commit_bytes=30000000
        - knob_storage_hard_limit_bytes=3000000000
        - knob_target_bytes_per_storage_server=2000000000
        - knob_target_bytes_per_storage_server_batch=1500000000
        - knob-max-generations-override=200
      podTemplate:
        spec:
          topologySpreadConstraints:
            - maxSkew: 1
              topologyKey: topology.kubernetes.io/zone
              whenUnsatisfiable: ScheduleAnyway
          affinity:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                  - matchExpressions:
                      - key: node.kubernetes.io/instance-type
                        operator: In
                        values:
                          # 32 CPU, 64GiB memory
                          - c6a.8xlarge
          containers:
            - name: foundationdb
              resources:
                requests:
                  cpu: 30
                  memory: 57Gi
              securityContext:
                runAsUser: 0
      volumeClaimTemplate:
        spec:
          storageClassName: gp3-iops16k-t1000
          resources:
            requests:
              storage: 2Ti
    storage:
      customParameters:
        - memory=26GiB
        - cache-memory=2GiB
        # Increase the default max outstanding IO operations (64), used in AIO with O_DIRECT interface.
        - knob_max_outstanding=128
        # Increase relocation and fetch keys parallelism to speed up data distribution across the cluster.
        - knob_relocation_parallelism_per_source_server=8
        - knob_fetch_keys_parallelism_bytes=4500000
        - knob_max_queue_commit_bytes=25000000
        - knob_storage_hard_limit_bytes=2500000000
        - knob_target_bytes_per_storage_server=1500000000
        - knob_target_bytes_per_storage_server_batch=1000000000
        - knob-max-generations-override=200
      podTemplate:
        spec:
          topologySpreadConstraints:
            - maxSkew: 1
              topologyKey: topology.kubernetes.io/zone
              whenUnsatisfiable: ScheduleAnyway
          affinity:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                  - matchExpressions:
                      - key: node.kubernetes.io/instance-type
                        operator: In
                        values:
                          # 32 CPU, 64GiB memory
                          - c6a.8xlarge
          containers:
            - name: foundationdb
              resources:
                requests:
                  cpu: 30
                  memory: 57Gi
              securityContext:
                runAsUser: 0
      volumeClaimTemplate:
        spec:
          storageClassName: gp3-iops16k-t1000
          resources:
            requests:
              storage: 16Ti
  sidecarContainer:
    enableReadinessProbe: false
    enableLivenessProbe: true
  routing:
    useDNSInClusterFile: true
  replaceInstancesWhenResourcesChange: true